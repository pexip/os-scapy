From: Guillaume Valadon <guillaume@valadon.net>
Date: Wed, 14 Oct 2020 11:33:54 +0200
Subject: [PATCH] Python 3.9 support (#2851)

* Unit tests linting for Python 3.9

* Python 3.9 support

Bug-Debian: https://bugs.debian.org/975519
Origin: upstream, https://github.com/secdev/scapy/commit/fba21efcddb7fbb94c24befa18edf82c6c791e69
---
 .github/workflows/unittests.yml |  16 +++---
 setup.py                        |   1 +
 test/contrib/nfs.uts            | 124 +++++++++-------------------------------
 test/contrib/portmap.uts        |  25 ++------
 tox.ini                         |   6 +-
 5 files changed, 43 insertions(+), 129 deletions(-)

diff --git a/.github/workflows/unittests.yml b/.github/workflows/unittests.yml
index 59bd578..fb8b072 100644
--- a/.github/workflows/unittests.yml
+++ b/.github/workflows/unittests.yml
@@ -10,9 +10,9 @@ jobs:
       - name: Checkout Scapy
         uses: actions/checkout@v2
       - name: Setup Python
-        uses: actions/setup-python@v1
+        uses: actions/setup-python@v2
         with:
-          python-version: 3.8
+          python-version: 3.9
       - name: Install tox
         run: pip install tox
       - name: Run flake8 tests
@@ -28,9 +28,9 @@ jobs:
       - name: Checkout Scapy
         uses: actions/checkout@v2
       - name: Setup Python
-        uses: actions/setup-python@v1
+        uses: actions/setup-python@v2
         with:
-          python-version: 3.8
+          python-version: 3.9
       - name: Install tox
         run: pip install tox
       - name: Build docs
@@ -42,9 +42,9 @@ jobs:
       - name: Checkout Scapy
         uses: actions/checkout@v2
       - name: Setup Python
-        uses: actions/setup-python@v1
+        uses: actions/setup-python@v2
         with:
-          python-version: 3.8
+          python-version: 3.9
       - name: Install tox
         run: pip install tox
       - name: Run mypy
@@ -56,12 +56,12 @@ jobs:
     runs-on: ubuntu-latest
     strategy:
       matrix:
-        python: [2.7, pypy2, pypy3, 3.5, 3.6, 3.7, 3.8]
+        python: [2.7, pypy2, pypy3, 3.5, 3.6, 3.7, 3.8, 3.9]
     steps:
       - name: Checkout Scapy
         uses: actions/checkout@v2
       - name: Setup Python
-        uses: actions/setup-python@v1
+        uses: actions/setup-python@v2
         with:
           python-version: ${{ matrix.python }}
       - name: Install Tox and any other packages
diff --git a/setup.py b/setup.py
index 7eb50e5..d0a83d0 100755
--- a/setup.py
+++ b/setup.py
@@ -95,6 +95,7 @@ setup(
         "Programming Language :: Python :: 3.6",
         "Programming Language :: Python :: 3.7",
         "Programming Language :: Python :: 3.8",
+        "Programming Language :: Python :: 3.9",
         "Topic :: Security",
         "Topic :: System :: Networking",
         "Topic :: System :: Networking :: Monitoring",
diff --git a/test/contrib/nfs.uts b/test/contrib/nfs.uts
index e1100a5..535eb05 100644
--- a/test/contrib/nfs.uts
+++ b/test/contrib/nfs.uts
@@ -601,104 +601,32 @@ pkt = ACCESS_Reply(
 )
 assert bytes(pkt) == b'\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x01\xed\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x03\xff\xff\xff\xff\xff\xff\xff\xff\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\x00\x00\x00\x04\x00\x00\x00\x05\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xdd\xdd\xdd\xdd\xee\xee\xee\xee\xff\xff\xff\xff\x11\x11\x11\x11""""3333\x00\x00\x00\n'
 
-pkt = READDIRPLUS_Reply(
-    status=0,
-    attributes_follow=1,
-    attributes=Fattr3(
-        type='NF3DIR',
-        mode=0o755,
-        nlink=1,
-        uid=2,
-        gid=3,
-        size=0xffffffffffffffff,
-        used=0xaaaaaaaaaaaaaaaa,
-        rdev=[4, 5],
-        fsid=0xbbbbbbbbbbbbbbbb,
-        fileid=0xcccccccccccccccc,
-        atime_s=0xdddddddd,
-        atime_ns=0xeeeeeeee,
-        mtime_s=0xffffffff,
-        mtime_ns=0x11111111,
-        ctime_s=0x22222222,
-        ctime_ns=0x33333333
-    ),
-    verifier=0xa,
-    value_follows=1,
-    files=[
-        File_From_Dir_Plus(
-            fileid=0xa,
-            filename=Object_Name(
-                length=5,
-                _name='file1',
-                fill='\x00\x00\x00'
-            ),
-            cookie=0xb,
-            attributes_follow=1,
-            attributes=Fattr3(
-                type='NF3REG',
-                mode=0o755,
-                nlink=1,
-                uid=2,
-                gid=3,
-                size=0xffffffffffffffff,
-                used=0xaaaaaaaaaaaaaaaa,
-                rdev=[4, 5],
-                fsid=0xbbbbbbbbbbbbbbbb,
-                fileid=0xcccccccccccccccc,
-                atime_s=0xdddddddd,
-                atime_ns=0xeeeeeeee,
-                mtime_s=0xffffffff,
-                mtime_ns=0x11111111,
-                ctime_s=0x22222222,
-                ctime_ns=0x33333333
-            ),
-            handle_follows=1,
-            filehandle=File_Object(
-                length=3,
-                fh='fh1',
-                fill='\x00'
-            ),
-            value_follows=1
-        ),
-
-        File_From_Dir_Plus(
-            fileid=0xb,
-            filename=Object_Name(
-                length=5,
-                _name='file2',
-                fill='\x00\x00\x00'
-            ),
-            cookie=0xc,
-            attributes_follow=1,
-            attributes=Fattr3(
-                type='NF3REG',
-                mode=0o755,
-                nlink=1,
-                uid=2,
-                gid=3,
-                size=0xffffffffffffffff,
-                used=0xaaaaaaaaaaaaaaaa,
-                rdev=[4, 5],
-                fsid=0xbbbbbbbbbbbbbbbb,
-                fileid=0xcccccccccccccccc,
-                atime_s=0xdddddddd,
-                atime_ns=0xeeeeeeee,
-                mtime_s=0xffffffff,
-                mtime_ns=0x11111111,
-                ctime_s=0x22222222,
-                ctime_ns=0x33333333
-            ),
-            handle_follows=1,
-            filehandle=File_Object(
-                length=3,
-                fh='fh2',
-                fill='\x00'
-            ),
-            value_follows=0
-        )
-    ],
-    eof=1
-)
+pkt = READDIRPLUS_Reply(status=0, attributes_follow=1,
+                        attributes=Fattr3(type='NF3DIR', mode=0o755, nlink=1, uid=2,
+                                          gid=3, size=0xffffffffffffffff, used=0xaaaaaaaaaaaaaaaa,
+                                          rdev=[4, 5], fsid=0xbbbbbbbbbbbbbbbb, fileid=0xcccccccccccccccc,
+                                          atime_s=0xdddddddd, atime_ns=0xeeeeeeee, mtime_s=0xffffffff,
+                                          mtime_ns=0x11111111, ctime_s=0x22222222, ctime_ns=0x33333333),
+                        verifier=0xa, value_follows=1,
+                        files=[File_From_Dir_Plus(fileid=0xa,
+                                                  filename=Object_Name(length=5, _name='file1', fill='\x00\x00\x00'),
+                                                  cookie=0xb, attributes_follow=1,
+                                                  attributes=Fattr3(type='NF3REG', mode=0o755, nlink=1, uid=2, gid=3,
+                                                                    size=0xffffffffffffffff, used=0xaaaaaaaaaaaaaaaa,
+                                                                    rdev=[4, 5], fsid=0xbbbbbbbbbbbbbbbb,
+                                                                    fileid=0xcccccccccccccccc, atime_s=0xdddddddd,
+                                                                    atime_ns=0xeeeeeeee, mtime_s=0xffffffff,
+                                                                    mtime_ns=0x11111111, ctime_s=0x22222222,
+                                                                    ctime_ns=0x33333333),
+                                                  handle_follows=1, filehandle=File_Object(length=3, fh='fh1', fill='\x00'),
+                                                  value_follows=1),
+                        File_From_Dir_Plus(fileid=0xb, filename=Object_Name(length=5, _name='file2', fill='\x00\x00\x00'),
+                        cookie=0xc, attributes_follow=1, attributes=Fattr3(type='NF3REG', mode=0o755, nlink=1, uid=2,
+                        gid=3, size=0xffffffffffffffff, used=0xaaaaaaaaaaaaaaaa, rdev=[4, 5], fsid=0xbbbbbbbbbbbbbbbb,
+                        fileid=0xcccccccccccccccc, atime_s=0xdddddddd, atime_ns=0xeeeeeeee, mtime_s=0xffffffff,
+                        mtime_ns=0x11111111, ctime_s=0x22222222, ctime_ns=0x33333333), handle_follows=1,
+                        filehandle=File_Object(length=3, fh='fh2', fill='\x00'), value_follows=0)
+                        ], eof=1)
 assert bytes(pkt) == b'\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x01\xed\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x03\xff\xff\xff\xff\xff\xff\xff\xff\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\x00\x00\x00\x04\x00\x00\x00\x05\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xdd\xdd\xdd\xdd\xee\xee\xee\xee\xff\xff\xff\xff\x11\x11\x11\x11""""3333\x00\x00\x00\x00\x00\x00\x00\n\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\n\x00\x00\x00\x05file1\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0b\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x01\xed\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x03\xff\xff\xff\xff\xff\xff\xff\xff\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\x00\x00\x00\x04\x00\x00\x00\x05\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xdd\xdd\xdd\xdd\xee\xee\xee\xee\xff\xff\xff\xff\x11\x11\x11\x11""""3333\x00\x00\x00\x01\x00\x00\x00\x03fh1\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x0b\x00\x00\x00\x05file2\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0c\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x01\xed\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x03\xff\xff\xff\xff\xff\xff\xff\xff\xaa\xaa\xaa\xaa\xaa\xaa\xaa\xaa\x00\x00\x00\x04\x00\x00\x00\x05\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xbb\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xcc\xdd\xdd\xdd\xdd\xee\xee\xee\xee\xff\xff\xff\xff\x11\x11\x11\x11""""3333\x00\x00\x00\x01\x00\x00\x00\x03fh2\x00\x00\x00\x00\x00\x00\x00\x00\x01'
 
 pkt = WRITE_Reply(
diff --git a/test/contrib/portmap.uts b/test/contrib/portmap.uts
index dd8a26a..4e58c1e 100644
--- a/test/contrib/portmap.uts
+++ b/test/contrib/portmap.uts
@@ -51,24 +51,9 @@ pkt = GETPORT_Reply(
 )
 assert bytes(pkt) == b'\x00\x00\x08\x01'
 
-pkt = DUMP_Reply(
-    value_follows=1,
-    mappings=[
-        Map_Entry(
-            prog=1,
-            vers=2,
-            prot=3,
-            port=4,
-            value_follows=1
-        ),
-
-        Map_Entry(
-            prog=5,
-            vers=6,
-            prot=7,
-            port=8,
-            value_follows=0
-        )
-    ]
-)
+pkt = DUMP_Reply(value_follows=1,
+                 mappings=[Map_Entry(prog=1, vers=2, prot=3, port=4, value_follows=1),
+                           Map_Entry(prog=5, vers=6, prot=7, port=8, value_follows=0),
+                          ]
+                 )
 assert bytes(pkt) == b'\x00\x00\x00\x01\x00\x00\x00\x01\x00\x00\x00\x02\x00\x00\x00\x03\x00\x00\x00\x04\x00\x00\x00\x01\x00\x00\x00\x05\x00\x00\x00\x06\x00\x00\x00\x07\x00\x00\x00\x08\x00\x00\x00\x00'
diff --git a/tox.ini b/tox.ini
index ff7e576..d190640 100644
--- a/tox.ini
+++ b/tox.ini
@@ -1,10 +1,10 @@
 # Scapy tox configuration file
-# Copyright (C) 2019 Guillaume Valadon <guillaume@valadon.net>
+# Copyright (C) 2020 Guillaume Valadon <guillaume@valadon.net>
 
 
 [tox]
-envlist = py{27,34,35,36,37,38,py,py3}-{linux,bsd}_{non_root,root},
-          py{27,34,25,36,37,38,py,py3}-windows,
+envlist = py{27,34,35,36,37,38,39,py,py3}-{linux,bsd}_{non_root,root},
+          py{27,34,25,36,37,38,39,py,py3}-windows,
 skip_missing_interpreters = true
 minversion = 2.9
 
